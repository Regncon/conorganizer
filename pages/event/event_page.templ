package event

import (
	"fmt"
	"database/sql"
	"log/slog"
	"net/http"

	"github.com/Regncon/conorganizer/pages/root"
	"github.com/Regncon/conorganizer/components"
	"github.com/Regncon/conorganizer/service/eventService"
	"github.com/Regncon/conorganizer/service/userctx"
	"github.com/Regncon/conorganizer/components/event_components"
)

templ event_page(eventId string, isAdmin bool, logger *slog.Logger, db *sql.DB, eventImageDir *string, r *http.Request) {
	<div id="event-container" class="event-container">
		@event_page_content(eventId, isAdmin, logger, db, eventImageDir, r)
	</div>
}

templ event_page_content(eventId string, isAdmin bool, logger *slog.Logger, db *sql.DB, eventImageDir *string, r *http.Request) {
	{{ userInfo := userctx.GetUserRequestInfo(r.Context()) }}
	{{ puljeId := r.URL.Query().Get("pulje") }}
	{{ event, err := eventservice.GetEventById(eventId, db, logger) }}
	{{ evnetsByPulje, err := root.GetEventsByPulje(db) }}
	{{ previousNextData, err := eventservice.GetPreviousNextByPuljeSimple(ctx, evnetsByPulje, logger, eventId, true, r, eventImageDir) }}
	if err != nil {
		logger.Error("Failed to get previous/next data", "error", err)
		return
	}
	if event == nil {
		<p>Event not found</p>
		return
	}
	if err != nil || event == nil {
		<p>Error fetching event: { err.Error() }</p>
	}
	@components.Breadcrumbs([]components.BreadcrumbPath{
		{Name: "Hjem", Url: "/"},
		{Name: event.Title, Url: ""},
	}) {
		@components.BreadcrumbNavButtons(previousNextData)
	}
	if isAdmin {
		<a
			href={ fmt.Sprintf("/admin/approval/edit/%s", event.ID) }
			class="btn btn--primary"
			style="margin:1rem;"
		>Administrator - rediger arrangementer</a>
	}
	@Event_mobile(event, previousNextData, eventImageDir)
	@event_components.EventInterests(userInfo, eventId, puljeId, db, logger)
}
