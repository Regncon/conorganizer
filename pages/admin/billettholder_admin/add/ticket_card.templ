package addbillettholder

import (
	"database/sql"
	"fmt"
	"html"
	"log/slog"
	"net/http"
	"strconv"
	"strings"
	"unicode"

	"github.com/gorilla/sessions"
	"github.com/Regncon/conorganizer/service/checkIn"
	"github.com/Regncon/conorganizer/components"
	"github.com/go-chi/chi/v5"
)

func highlightSearchTerm(text, searchTerm string) string {
	if len(searchTerm) == 0 {
		return html.EscapeString(text)
	}

	// Build a quick-lookup set of runes in searchTerm (lower-cased).
	set := make(map[rune]struct{}, len(searchTerm))
	for _, r := range searchTerm {
		set[unicode.ToLower(r)] = struct{}{}
	}

	var out strings.Builder
	for _, r := range text {
		escaped := html.EscapeString(string(r)) // protect any HTML in the input
		if _, ok := set[unicode.ToLower(r)]; ok {
			out.WriteString("<b style=\"color: var(--color-primary-strong);\">")
			out.WriteString(escaped)
			out.WriteString("</b>")
		} else {
			out.WriteString(escaped)
		}
	}

	return out.String()
}
func ConvertTicketToBillettholderRoute(
	router chi.Router,
	db *sql.DB,
	store sessions.Store,
	notifyUpdate func(string),
	logger *slog.Logger,
) {
	router.Route("/convert/", func(ticketIdRouter chi.Router) {
		ticketIdRouter.Get("/{ticketID}/", func(w http.ResponseWriter, r *http.Request) {
			ticketIDStr := chi.URLParam(r, "ticketID")
			ticketID, err := strconv.Atoi(ticketIDStr)
			if err != nil {
				http.Error(w, "invalid ticket ID", http.StatusBadRequest)
				return
			}

			err = checkIn.ConvertTicketToBillettholder(ticketID, db, logger)
			if err != nil {
				http.Error(w, fmt.Sprintf("failed to convert ticket to billettholder: %v", err), http.StatusInternalServerError)
				return
			}

			sessionID, _ := upsertSessionID(store, r, w)
			if notifyUpdate != nil {
				notifyUpdate(sessionID)
			}
		})

	})
}

const TicketTypeMiddag = 193284

templ ticketCard(ticket checkIn.CheckInTicket, isBllettholder bool, searchTerm string) {
	<div class="card" style="display:flex; flex-direction:column; gap:0.5rem; padding: 1rem; border-radius: 8px; background: rgb(49, 53, 78); color: #ffffff;">
		<p style="margin:0;">
			<strong>Bestilling:</strong> @templ.Raw(highlightSearchTerm(strconv.Itoa(ticket.OrderID), searchTerm))
		</p>
		<p style="margin:0;">
			<strong>Type:</strong> @templ.Raw(highlightSearchTerm(ticket.Type, searchTerm))
		</p>
		<p style="margin:0;">
			<strong>Navn:</strong>
			<em>
				@templ.Raw(highlightSearchTerm(ticket.FirstName+""+ticket.LastName, searchTerm))
			</em>
		</p>
		<a href={ "mailto:" + ticket.Email }>
			@templ.Raw(highlightSearchTerm(ticket.Email, searchTerm))
		</a>
		<div style="display: flex; align-items: center; gap:0.5rem; ">
			if ticket.IsOver18 {
				@components.Icon(components.IconEventAdultOnly, components.IconSize24)
				<p><strong>Alder:</strong> Over 18</p>
			} else {
				@components.Icon(components.IconEventChildFriendly, components.IconSize24)
				<p><strong>Alder:</strong> Under 18</p>
			}
		</div>
		if ticket.TypeId == TicketTypeMiddag {
			<p style="margin:0; color: var(--color-accent);">
				<strong>Merk:</strong> Dette er en middagsbillett.
			</p>
		} else if isBllettholder {
			<p style="margin:0; color: var(--color-accent);">
				<strong>Merk:</strong> Denne billetten er allerede konvertert til en billettholder.
			</p>
		} else {
			<button
				class="btn btn--outline"
				data-on-click={ templ.URL(fmt.Sprintf("@get('/admin/billettholder/add/api/convert/%s/')", strconv.Itoa(ticket.ID))) }
			>
				Konverter billett til deltager
			</button>
		}
	</div>
}
