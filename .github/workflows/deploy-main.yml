name: Deploy main to Hetzner

on:
    workflow_run:
        workflows:
            - Conorganizer_build_and_test #WARING!: Must match the name: in build.yml
        types:
            - completed

permissions:
    contents: read

jobs:
    deploy:
        if: >
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == '274-bytte-service-provider-basic-oppsett'

        runs-on: ubuntu-latest

        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  # downloads all artifacts from the triggering workflow into ./artifacts
                  path: artifacts

            - name: Checkout repo (for deploy files)
              uses: actions/checkout@v4

            - name: Locate conorganizer binary from artifacts
              id: find_binary
              run: |
                  set -euo pipefail
                  BIN_PATH=$(find artifacts -type f -name 'conorganizer' | head -n 1 || true)
                  if [ -z "$BIN_PATH" ]; then
                    echo "conorganizer binary not found in artifacts" >&2
                    exit 1
                  fi
                  echo "bin_path=$BIN_PATH" >> "$GITHUB_OUTPUT"

            - name: Prepare deploy bundle
              run: |
                  set -euo pipefail
                  mkdir -p deploy_bundle
                  # rename to conorganizer.new for the script
                  cp "${{ steps.find_binary.outputs.bin_path }}" deploy_bundle/conorganizer.new
                  # deploy script and systemd unit from repo
                  cp deploy/deploy.sh deploy_bundle/deploy.sh
                  cp deploy/conorganizer.service deploy_bundle/conorganizer.service
                  ls -l deploy_bundle

            - name: Upload bundle to Hetzner
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.HETZNER_HOST }}
                  username: ${{ secrets.HETZNER_USER }}
                  key: ${{ secrets.HETZNER_SSH_KEY }}
                  port: 22
                  source: "deploy_bundle/*"
                  target: "/opt/conorganizer"

            - name: Install service and run deploy script on Hetzner
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.HETZNER_HOST }}
                  username: ${{ secrets.HETZNER_USER }}
                  key: ${{ secrets.HETZNER_SSH_KEY }}
                  port: 22
                  script_stop: true
                  script: |
                      set -euo pipefail

                      APP_DIR="/opt/conorganizer"
                      SERVICE_PATH="$APP_DIR/conorganizer.service"
                      SYSTEMD_UNIT="/etc/systemd/system/conorganizer.service"

                      if [ ! -f "$SERVICE_PATH" ]; then
                        echo "Service file not found at $SERVICE_PATH" >&2
                        exit 1
                      fi

                      # Install/overwrite systemd unit
                      sudo mv "$SERVICE_PATH" "$SYSTEMD_UNIT"
                      sudo chmod 644 "$SYSTEMD_UNIT"

                      # Make sure deploy.sh is executable
                      sudo chmod +x "$APP_DIR/deploy.sh"

                      # Enable service (idempotent)
                      sudo systemctl daemon-reload
                      sudo systemctl enable conorganizer.service || true

                      # Run deploy script (handles binary promotion + restart)
                      sudo "$APP_DIR/deploy.sh"
