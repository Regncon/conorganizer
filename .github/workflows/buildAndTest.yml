name: Conorganizer build and test

on:
    push:
        branches: ["**"]

    pull_request:
        branches: ["**"]
        types: [opened, reopened, synchronize]

permissions:
    contents: read

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"
                  cache: true

            - name: Generate template files (templ via go.mod tool)
              run: go tool templ generate

            - name: Run tests
              run: go test ./...

            - name: Build binary
              run: go build -o conorganizer

            - name: Upload binary artifact
              uses: actions/upload-artifact@v4
              with:
                  name: conorganizer
                  path: conorganizer

    deploy:
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: Production

        steps:
            - name: Checkout repo (for deploy files)
              uses: actions/checkout@v4

            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: conorganizer
                  path: artifacts

            - name: Prepare deploy bundle
              run: |
                  set -euo pipefail
                  mkdir -p deploy_bundle
                  # rename to conorganizer.new for the script
                  cp artifacts/conorganizer deploy_bundle/conorganizer.new
                  # deploy script and systemd unit from repo
                  cp deploy/deploy.sh deploy_bundle/deploy.sh
                  cp deploy/conorganizer.service deploy_bundle/conorganizer.service
                  ls -l deploy_bundle

            - name: Check that HETZNER_SSH_KEY is set
              run: |
                  if [ -z "${{ secrets.HETZNER_SSH_KEY }}" ]; then
                    echo "HETZNER_SSH_KEY is empty or not available in this context" >&2
                    exit 1
                  fi
                  echo "HETZNER_SSH_KEY is set (value is masked in logs)."

            - name: Upload bundle to Hetzner
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.HETZNER_HOST }}
                  username: ${{ secrets.HETZNER_USER }}
                  key: ${{ secrets.HETZNER_SSH_KEY }}
                  port: 22
                  source: "deploy_bundle"
                  target: "/opt/conorganizer"
                  strip_components: 1

            - name: Install service and run deploy script on Hetzner
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.HETZNER_HOST }}
                  username: ${{ secrets.HETZNER_USER }}
                  key: ${{ secrets.HETZNER_SSH_KEY }}
                  port: 22
                  script_stop: true
                  script: |
                      set -euo pipefail

                      APP_DIR="/opt/conorganizer"
                      SERVICE_PATH="$APP_DIR/conorganizer.service"
                      SYSTEMD_UNIT="/etc/systemd/system/conorganizer.service"

                      if [ ! -f "$SERVICE_PATH" ]; then
                        echo "Service file not found at $SERVICE_PATH" >&2
                        exit 1
                      fi

                      # Install/overwrite systemd unit
                      sudo mv "$SERVICE_PATH" "$SYSTEMD_UNIT"
                      sudo chmod 644 "$SYSTEMD_UNIT"

                      # Make sure deploy.sh is executable
                      sudo chmod +x "$APP_DIR/deploy.sh"

                      # Enable service (idempotent)
                      sudo systemctl daemon-reload
                      sudo systemctl enable conorganizer.service || true

                      # Run deploy script (handles binary promotion + restart)
                      sudo "$APP_DIR/deploy.sh"
